<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Cliniflow Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#0b1220; color:#e6eaf2 }
  h1,h2{ margin:0 0 8px }
  .app{ display:flex; height:100vh }
  .col{ padding:16px; overflow:auto }
  .left{ width:260px; border-right:1px solid #1c2432 }
  .mid{ width:520px; border-right:1px solid #1c2432 }
  .right{ flex:1 }

  .pitem{ padding:10px; border-radius:10px; cursor:pointer; margin-bottom:6px; background:#0f172a }
  .pitem:hover{ background:#162033 }
  .pitem.active{ background:#1e293b }

  .box{ background:#0f172a; border:1px solid #1c2432; border-radius:14px; padding:12px; margin-bottom:12px }
  .muted{ color:#9ca3af; font-size:12px }

  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  button{ background:#1f2937; border:1px solid #334155; color:#e5e7eb; padding:6px 10px; border-radius:10px; cursor:pointer }
  button:hover{ border-color:#60a5fa }

  .btnDanger{ background:#3a1620; border-color:#5a2232; color:#ffd7df }
  .btnDanger:hover{ border-color:#ff6a8a }

  .procRow{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:6px 0; border-top:1px dashed #1c2432 }
  .procSelect{ background:#0b1220;color:#e6eaf2;border:1px solid #1c2432;border-radius:8px;padding:3px 6px;font-size:12px }

  /* tooth list badge */
  .toothRow{ display:flex; justify-content:space-between; align-items:center; gap:8px }
  .toothBadge{
    min-width:22px; height:22px; border-radius:11px;
    display:flex; align-items:center; justify-content:center;
    font-size:12px; font-weight:700; color:#0b1220
  }
  .toothDone{ background:#4ade80 }
  .toothPlanned{ background:#facc15 }
  .toothCanceled{ background:#9ca3af }

  /* FDI Grid */
  .fdiWrap{ display:flex; flex-direction:column; gap:10px }
  .fdiRow{ display:flex; justify-content:space-between; gap:10px }
  .quad{ flex:1; background:#0b1220; border:1px solid #1c2432; border-radius:12px; padding:10px }
  .quadTitle{ font-size:12px; color:#9ca3af; margin-bottom:8px }
  .teeth{ display:flex; gap:6px; flex-wrap:wrap }
  .toothBtn{
    width:44px; height:44px;
    border-radius:12px;
    border:1px solid #1c2432;
    background:#0f172a;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    cursor:pointer;
    position:relative;
  }
  .toothBtn:hover{ border-color:#60a5fa }
  .toothBtn.selected{ outline:2px solid #60a5fa; outline-offset:2px }

  .toothNum{ font-size:12px; font-weight:800; line-height:1 }
  .toothCount{
    position:absolute; top:6px; right:6px;
    width:18px; height:18px; border-radius:9px;
    display:flex; align-items:center; justify-content:center;
    font-size:11px; font-weight:800; color:#0b1220;
  }
  .toothStateDone{ background:#4ade80 }
  .toothStatePlanned{ background:#facc15 }
  .toothStateNone{ background:#9ca3af }

  .selRow label{ font-size:12px; color:#9ca3af; }
  select{ background:#0b1220;color:#e6eaf2;border:1px solid #1c2432;border-radius:10px;padding:6px 10px }
</style>
</head>

<body>
<div class="app">

  <!-- LEFT: PATIENTS -->
  <div class="col left">
    <h2>Patients</h2>
    <div id="patients"></div>
    <div id="status" class="muted" style="margin-top:10px;"></div>
  </div>

  <!-- MID: TREATMENTS -->
  <div class="col mid">
    <h2>Treatments</h2>

    <!-- FDI GRID -->
    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:800;">FDI Grid</div>
          <div class="muted">Click a tooth to select it for Add Procedure.</div>
        </div>
        <button id="btnRefresh">Refresh</button>
      </div>
      <div style="height:10px"></div>
      <div id="fdiGrid" class="fdiWrap"></div>
    </div>

    <!-- ADD PROCEDURE -->
    <div class="box">
      <div style="font-weight:800; margin-bottom:8px;">Add Procedure</div>
      <div class="row selRow">
        <label>Tooth</label>
        <select id="addTooth"></select>

        <label style="margin-left:6px;">Type</label>
        <select id="addType">
          <option>IMPLANT</option>
          <option>CROWN</option>
          <option>FILLING</option>
          <option>ROOT_CANAL</option>
        </select>

        <label style="margin-left:6px;">Status</label>
        <select id="addStatus">
          <option>PLANNED</option>
          <option>SCHEDULED</option>
          <option>DONE</option>
          <option>CANCELED</option>
        </select>

        <button id="btnAdd">Add</button>
      </div>
      <div id="addMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- LIST -->
    <div id="treatList"></div>
  </div>

  <!-- RIGHT: TRAVEL -->
  <div class="col right">
    <h2>Travel</h2>
    <div id="travelBox" class="box muted">Select patient</div>
  </div>

</div>

<script>
let SELECTED_PATIENT_ID = null;
let SELECTED_TOOTH_ID = null;

const elPatients = document.getElementById("patients");
const elTreatList = document.getElementById("treatList");
const elTravelBox = document.getElementById("travelBox");
const elFDI = document.getElementById("fdiGrid");
const elAddTooth = document.getElementById("addTooth");
const elAddType = document.getElementById("addType");
const elAddStatus = document.getElementById("addStatus");
const elAddMsg = document.getElementById("addMsg");
const elStatus = document.getElementById("status");

function setStatus(msg){ elStatus.textContent = msg || ""; }

function fillFDISelect(){
  elAddTooth.innerHTML = "";
  const adult = [
    ...Array.from({length:8},(_,i)=>String(11+i)),
    ...Array.from({length:8},(_,i)=>String(21+i)),
    ...Array.from({length:8},(_,i)=>String(31+i)),
    ...Array.from({length:8},(_,i)=>String(41+i)),
  ];
  adult.forEach(id=>{
    const o=document.createElement("option");
    o.value=id; o.textContent=id;
    elAddTooth.appendChild(o);
  });
}

function selectTooth(toothId){
  SELECTED_TOOTH_ID = toothId;
  elAddTooth.value = toothId;
  // highlight in grid
  document.querySelectorAll(".toothBtn").forEach(b=>{
    b.classList.toggle("selected", b.dataset.tooth === toothId);
  });
}

function toothSummaryClass(procs){
  const arr = Array.isArray(procs) ? procs : [];
  if (arr.some(p=>p.status==="DONE")) return "toothStateDone";
  if (arr.some(p=>p.status==="PLANNED" || p.status==="SCHEDULED")) return "toothStatePlanned";
  return "toothStateNone";
}

function buildToothMap(json){
  const map = new Map(); // toothId -> {count, cls}
  const teeth = Array.isArray(json && json.teeth) ? json.teeth : [];
  teeth.forEach(t=>{
    const id = String(t.toothId||"").trim();
    if(!id) return;
    const procs = Array.isArray(t.procedures) ? t.procedures : [];
    map.set(id, { count: procs.length, cls: toothSummaryClass(procs) });
  });
  return map;
}

function renderFDIGrid(json){
  elFDI.innerHTML = "";
  const map = buildToothMap(json);

  const mkQuad = (title, toothIds) => {
    const q = document.createElement("div");
    q.className = "quad";
    const qt = document.createElement("div");
    qt.className = "quadTitle";
    qt.textContent = title;
    const wrap = document.createElement("div");
    wrap.className = "teeth";

    toothIds.forEach(id=>{
      const btn = document.createElement("div");
      btn.className = "toothBtn";
      btn.dataset.tooth = id;
      if (SELECTED_TOOTH_ID === id) btn.classList.add("selected");

      const num = document.createElement("div");
      num.className = "toothNum";
      num.textContent = id;

      const meta = map.get(id) || { count: 0, cls: "toothStateNone" };
      const count = document.createElement("div");
      count.className = "toothCount " + meta.cls;
      count.textContent = String(meta.count);

      btn.appendChild(num);
      btn.appendChild(count);

      btn.addEventListener("click", ()=>selectTooth(id));
      wrap.appendChild(btn);
    });

    q.appendChild(qt);
    q.appendChild(wrap);
    return q;
  };

  // Upper: Q1 (11-18) + Q2 (21-28)
  const upper = document.createElement("div");
  upper.className = "fdiRow";
  upper.appendChild(mkQuad("Upper Right (Q1): 11–18", ["11","12","13","14","15","16","17","18"]));
  upper.appendChild(mkQuad("Upper Left (Q2): 21–28", ["21","22","23","24","25","26","27","28"]));

  // Lower: Q3 (31-38) + Q4 (41-48)
  const lower = document.createElement("div");
  lower.className = "fdiRow";
  lower.appendChild(mkQuad("Lower Left (Q3): 31–38", ["31","32","33","34","35","36","37","38"]));
  lower.appendChild(mkQuad("Lower Right (Q4): 41–48", ["41","42","43","44","45","46","47","48"]));

  elFDI.appendChild(upper);
  elFDI.appendChild(lower);
}

async function loadPatients(){
  const r = await fetch("/api/patients");
  const j = await r.json();
  elPatients.innerHTML="";
  (j.patients||[]).forEach(p=>{
    const d=document.createElement("div");
    d.className="pitem";
    d.textContent=p.name || p.id;
    d.onclick=()=>selectPatient(p,d);
    elPatients.appendChild(d);
  });
}

async function selectPatient(p,el){
  document.querySelectorAll(".pitem").forEach(x=>x.classList.remove("active"));
  el.classList.add("active");
  SELECTED_PATIENT_ID=p.id;
  setStatus("Selected: " + p.id);
  await loadTreatments();
  await loadTravel();
}

async function loadTreatments(){
  if(!SELECTED_PATIENT_ID){
    elTreatList.innerHTML = "<div class='muted'>Select patient</div>";
    elFDI.innerHTML = "";
    return;
  }
  const r = await fetch(`/api/patient/${encodeURIComponent(SELECTED_PATIENT_ID)}/treatments`);
  const j = await r.json();
  renderFDIGrid(j);
  renderTreatments(j);

  // If nothing selected yet, choose 11
  if(!SELECTED_TOOTH_ID){
    selectTooth(elAddTooth.value || "11");
  } else {
    selectTooth(SELECTED_TOOTH_ID);
  }
}

function renderTreatments(json){
  elTreatList.innerHTML="";
  const teeth = (json.teeth||[]);
  if(!teeth.length){
    elTreatList.innerHTML = "<div class='muted'>No treatments</div>";
    return;
  }

  teeth.forEach(t=>{
    const item=document.createElement("div");
    item.className="box";

    const procs = Array.isArray(t.procedures) ? t.procedures : [];

    // Header with badge + color
    const header=document.createElement("div");
    header.className="toothRow";

    const title=document.createElement("div");
    title.className="titemTitle";
    title.textContent = (t.jaw||"?") + " " + (t.toothId||"?");

    const badge=document.createElement("div");
    badge.className="toothBadge";
    badge.textContent=procs.length;

    let cls="toothCanceled";
    if(procs.some(p=>p.status==="DONE")) cls="toothDone";
    else if(procs.some(p=>p.status==="PLANNED" || p.status==="SCHEDULED")) cls="toothPlanned";
    badge.classList.add(cls);

    header.appendChild(title);
    header.appendChild(badge);
    item.appendChild(header);

    if(!procs.length){
      const m=document.createElement("div");
      m.className="muted";
      m.style.marginTop="8px";
      m.textContent="No procedures";
      item.appendChild(m);
    }

    procs.forEach(p=>{
      const row=document.createElement("div");
      row.className="procRow";

      const left=document.createElement("div");
      left.className="muted";
      left.textContent = (p.type||"?");

      const right=document.createElement("div");
      right.style.display="flex";
      right.style.gap="8px";
      right.style.alignItems="center";

      const sel=document.createElement("select");
      sel.className="procSelect";
      ["PLANNED","SCHEDULED","DONE","CANCELED"].forEach(st=>{
        const o=document.createElement("option");
        o.value=st; o.textContent=st;
        if((p.status||"PLANNED")===st) o.selected=true;
        sel.appendChild(o);
      });
      sel.onchange = ()=>updateProcedure(p.id,{status:sel.value});

      const del=document.createElement("button");
      del.className="btnDanger";
      del.textContent="Delete";
      del.onclick=()=>deleteProcedure(p.id);

      right.appendChild(sel);
      right.appendChild(del);

      row.appendChild(left);
      row.appendChild(right);
      item.appendChild(row);
    });

    elTreatList.appendChild(item);
  });
}

async function updateProcedure(id,patch){
  if(!SELECTED_PATIENT_ID) return;
  const res = await fetch(`/api/patient/${encodeURIComponent(SELECTED_PATIENT_ID)}/treatments/procedure/${encodeURIComponent(id)}`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json", "Accept":"application/json" },
    body:JSON.stringify(patch||{})
  });
  if(!res.ok){
    const txt = await res.text();
    alert("PATCH failed: " + res.status + " " + txt);
    return;
  }
  await loadTreatments();
}

async function deleteProcedure(id){
  if(!SELECTED_PATIENT_ID) return;
  const ok = confirm("Delete this procedure?");
  if(!ok) return;

  const res = await fetch(`/api/patient/${encodeURIComponent(SELECTED_PATIENT_ID)}/treatments/procedure/${encodeURIComponent(id)}`,{
    method:"DELETE",
    headers:{ "Accept":"application/json" }
  });
  if(!res.ok){
    const txt = await res.text();
    alert("DELETE failed: " + res.status + " " + txt);
    return;
  }
  await loadTreatments();
}

document.getElementById("btnAdd").onclick=async()=>{
  if(!SELECTED_PATIENT_ID){
    alert("Select patient first");
    return;
  }
  const body = {
    toothId: elAddTooth.value,
    type: elAddType.value,
    status: elAddStatus.value
  };

  const res = await fetch(`/api/patient/${encodeURIComponent(SELECTED_PATIENT_ID)}/treatments/procedure`,{
    method:"POST",
    headers:{ "Content-Type":"application/json", "Accept":"application/json" },
    body:JSON.stringify(body)
  });

  const txt = await res.text();
  let j=null;
  try{ j=JSON.parse(txt);}catch(e){}
  if(!res.ok){
    alert("POST failed: " + res.status + " " + txt);
    return;
  }
  elAddMsg.textContent = "Added: " + body.toothId + " " + body.type + " (" + body.status + ")";
  await loadTreatments();
};

document.getElementById("btnRefresh").onclick = ()=>loadTreatments();

async function loadTravel(){
  if(!SELECTED_PATIENT_ID){
    elTravelBox.textContent = "Select patient";
    return;
  }
  const r = await fetch(`/api/patient/${encodeURIComponent(SELECTED_PATIENT_ID)}/travel`);
  const j = await r.json();
  // basic display (you already have detailed view elsewhere)
  const hotel = j.hotel || "-";
  const flights = Array.isArray(j.flights) ? j.flights : [];
  const notes = j.notes || "-";

  let html = `<div><b>Hotel</b><div class="muted">${hotel}</div></div><div style="height:10px"></div>`;
  html += `<div><b>Flights</b></div>`;
  if(!flights.length) html += `<div class="muted">-</div>`;
  flights.forEach(f=>{
    html += `<div class="muted">• ${f.dir||""} ${f.from||""} → ${f.to||""} ${f.date||""} ${f.time||""} ${f.flightNo||""}</div>`;
  });
  html += `<div style="height:10px"></div><div><b>Notes</b><div class="muted">${notes}</div></div>`;
  elTravelBox.innerHTML = html;
}

fillFDISelect();
selectTooth("11");
loadPatients();
</script>
</body>
</html>
